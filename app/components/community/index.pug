extends ../common/layout
block content
    header.bg-dark
        .container-fluid
            .row.float-right.p-2.no-gutters
                a(id="logout", href="#" class="btn btn-primary float-right") Logout
    #content
        .continer-fluid
            .row.no-gutters
                .col-lg-10.col-md-10.col-sm-10
                    ul#messages
                div(class="col-lg-2 bg-light col-md-2 col-sm-2" )
                    h5 Users
                        div#userList
    footer.bg-dark
        form(action='./', method='post', id='chatForm')
            .container-fluid
                .row.no-gutters
                    .col-lg-10.p-2.col-md-10.col-sm-10
                        input(id='txt', class='form-control' autocomplete='off', autofocus='on', placeholder='type your message here...')
                    .col-lg-2.p-2.col-md-2.col-sm-2
                        button(class='btn btn-primary btn-block') Send

    script.
        let host_url = '#{ host }';
        let socket = io.connect(host_url);

        $('#logout').click(function(e){
            
            e.preventDefault();
            
            $.ajax({
                type: 'POST',
                url: '//' + host_url + '/users/logout',
                contentType:  'application/json; charset=utf-8',
                data: JSON.stringify({ 'logout': true }),
                dataType: 'json',
                success: function(response){
                    if (response.status == 'ok') {
                        window.location.replace('//' + host_url + '/')
                    }
                    else {
                        
                    }
                },
                failure: function(error) {
                    $('.invalid-feedback').html('Username Taken');
                    $('#email').addClass('is-invalid');
                }
            });
        })

        $('form').submit(function(e) {
            e.preventDefault();

            socket.emit('chat_message', $('#txt').val());
            $('#txt').val('');

            return false;
        });

        socket.on('chat_message', function(msg){
            $('#messages').append($('<li>').html(msg));
        });

        socket.on('is_online', function(username){
            $('#messages').append($('<li>').html(username));
            
        });

        socket.on('enter_chat', function(username){
            $('#userList').append($('<li>').html(username));
        });

        socket.on('leave_chat', function(username){
        $('#userList > li:contains("'+username+'")').remove();
        });

        let chatName = '#{session.username}'
        socket.emit('username', chatName);